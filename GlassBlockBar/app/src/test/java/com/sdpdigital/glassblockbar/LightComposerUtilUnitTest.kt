package com.sdpdigital.glassblockbar

import com.sdpdigital.glassblockbar.ble.Utils
import org.junit.Assert.assertEquals
import org.junit.Test
import kotlin.math.round

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class LightComposerUtilUnitTest {

    val LOG_TAG = LightComposerUtilUnitTest::class.java.simpleName

    val nearest24thBeatTestCases = arrayOf(
            arrayOf(0, 0, 0, 0, 0, 0, 0, 0, 0),
            arrayOf(1, 1, 1, 1, 1, 1, 1, 1, 1),
            arrayOf(2, 2, 2, 2, 2, 2, 2, 2, 2),
            arrayOf(3, 3, 3, 3, 3, 3, 3, 3, 3),
            arrayOf(4, 4, 4, 4, 4, 4, 4, 4, 4),
            arrayOf(5, 5, 5, 5, 5, 5, 5, 5, 5),
            arrayOf(4, 3, 2, 1, 0, 4, 3, 2, 1),
            arrayOf(0, 1, 2, 3, 4, 0, 1, 2, 3),
            arrayOf(0, 1, 2, 3, 4, 5, 1, 2, 3),
            arrayOf(5, 4, 3, 2, 1, 0, 5, 4, 3),
            arrayOf(1, 0, 1, 1, 1, 1, 2, 2, 5, 0, 0, 0))

    @Test
    fun syncToNearest24thBeatMicros_Test() {
        // Check within 9 decimal places
        val delta9Dec = .000000001
        val bpmStartTimeMicros = 0L
        for (bpmAndMicros in syncTo24thTests) {
            // StartTime of 0
            val bpm = bpmAndMicros[0].toInt()
            val microsOfHalfQuarterBeat = bpmAndMicros[3].toLong()
            val actual24thBeatRoundDown = Utils
                .syncToNearest24thBeatMicros(microsOfHalfQuarterBeat, bpm, bpmStartTimeMicros)
            assertEquals(0.0, actual24thBeatRoundDown, delta9Dec)
            val actual24thBeatRoundUp = Utils
                .syncToNearest24thBeatMicros(microsOfHalfQuarterBeat + 1L, bpm, bpmStartTimeMicros)
            assertEquals(bpmAndMicros[2], actual24thBeatRoundUp, delta9Dec)
        }
    }

    @Test
    fun syncToNearest24thBeat_Test() {
        val bpmStartTimeMicros = 0L
        for (bpmAndMicros in syncTo24thTests) {
            // StartTime of 0
            val bpm = bpmAndMicros[0].toInt()
            val microsOfHalfQuarterBeat = bpmAndMicros[3].toLong()
            val actual24thBeatRoundDown = Utils
                .syncToNearest24thBeat(microsOfHalfQuarterBeat, bpm, bpmStartTimeMicros)
            assertEquals(0, actual24thBeatRoundDown)
            val actual24thBeatRoundUp = Utils
                .syncToNearest24thBeat(microsOfHalfQuarterBeat + 1L, bpm, bpmStartTimeMicros)
            assertEquals(1, actual24thBeatRoundUp)
        }
    }

    @Test
    fun microsInBeat_Test() {
        // Check within 9 decimal places
        val delta9Dec = .000000001

        for (bpmAndMicros in microsInBeatTests) {
            val actualBpm = Utils.bpm(bpmAndMicros[1])
            val actualBeatMicros = Utils.microsInBeat(bpmAndMicros[0].toInt())
            assertEquals(round(bpmAndMicros[0]).toInt(), actualBpm)
            assertEquals(bpmAndMicros[1], actualBeatMicros, delta9Dec)
        }
    }

    val syncTo24thTests: Array<Array<Double>> = arrayOf(
        arrayOf(60.0,  1000000.000000000, 41666.6666666667, 20833.33333333330),
        arrayOf(61.0,	983606.557377049, 40983.6065573770, 20491.80327868850),
        arrayOf(62.0,	967741.935483871, 40322.5806451613, 20161.29032258060),
        arrayOf(63.0,	952380.952380952, 39682.5396825397, 19841.26984126980),
        arrayOf(64.0,	937500.000000000, 39062.5000000000, 19531.25000000000),
        arrayOf(65.0,	923076.923076923, 38461.5384615385, 19230.76923076920),
        arrayOf(66.0,	909090.909090909, 37878.7878787879, 18939.39393939390),
        arrayOf(67.0,	895522.388059701, 37313.4328358209, 18656.71641791040),
        arrayOf(68.0,	882352.941176471, 36764.7058823530, 18382.35294117650),
        arrayOf(69.0,	869565.217391304, 36231.8840579710, 18115.94202898550),
        arrayOf(70.0,	857142.857142857, 35714.2857142857, 17857.14285714290),
        arrayOf(71.0,	845070.422535211, 35211.2676056338, 17605.63380281690),
        arrayOf(72.0,	833333.333333333, 34722.2222222222, 17361.11111111110),
        arrayOf(73.0,	821917.808219178, 34246.5753424658, 17123.28767123290),
        arrayOf(74.0,	810810.810810811, 33783.7837837838, 16891.89189189190),
        arrayOf(75.0,	800000.000000000, 33333.3333333333, 16666.66666666670),
        arrayOf(76.0,	789473.684210526, 32894.7368421053, 16447.36842105260),
        arrayOf(77.0,	779220.779220779, 32467.5324675325, 16233.76623376620),
        arrayOf(78.0,	769230.769230769, 32051.2820512820, 16025.64102564100),
        arrayOf(79.0,	759493.670886076, 31645.5696202532, 15822.78481012660),
        arrayOf(80.0,	750000.000000000, 31250.0000000000, 15625.00000000000),
        arrayOf(81.0,	740740.740740741, 30864.1975308642, 15432.09876543210),
        arrayOf(82.0,	731707.317073171, 30487.8048780488, 15243.90243902440),
        arrayOf(83.0,	722891.566265060, 30120.4819277108, 15060.24096385540),
        arrayOf(84.0,	714285.714285714, 29761.9047619048, 14880.95238095240),
        arrayOf(85.0,	705882.352941176, 29411.7647058823, 14705.88235294120),
        arrayOf(86.0,	697674.418604651, 29069.7674418605, 14534.88372093020),
        arrayOf(87.0,	689655.172413793, 28735.6321839080, 14367.81609195400),
        arrayOf(88.0,	681818.181818182, 28409.0909090909, 14204.54545454550),
        arrayOf(89.0,	674157.303370787, 28089.8876404495, 14044.94382022470),
        arrayOf(90.0,	666666.666666667, 27777.7777777778, 13888.88888888890),
        arrayOf(91.0,	659340.659340659, 27472.5274725275, 13736.26373626370),
        arrayOf(92.0,	652173.913043478, 27173.9130434783, 13586.95652173910),
        arrayOf(93.0,	645161.290322581, 26881.7204301075, 13440.86021505380),
        arrayOf(94.0,	638297.872340426, 26595.7446808511, 13297.87234042550),
        arrayOf(95.0,	631578.947368421, 26315.7894736842, 13157.89473684210),
        arrayOf(96.0,	625000.000000000, 26041.6666666667, 13020.83333333330),
        arrayOf(97.0,	618556.701030928, 25773.1958762887, 12886.59793814430),
        arrayOf(98.0,	612244.897959184, 25510.2040816327, 12755.10204081630),
        arrayOf(99.0,	606060.606060606, 25252.5252525253, 12626.26262626260),
        arrayOf(100.0,  600000.000000000, 25000.0000000000, 12500.00000000000),
        arrayOf(101.0,  594059.405940594, 24752.4752475248, 12376.23762376240),
        arrayOf(102.0,  588235.294117647, 24509.8039215686, 12254.90196078430),
        arrayOf(103.0,  582524.271844660, 24271.8446601942, 12135.92233009710),
        arrayOf(104.0,  576923.076923077, 24038.4615384615, 12019.23076923080),
        arrayOf(105.0,  571428.571428571, 23809.5238095238, 11904.76190476190),
        arrayOf(106.0,  566037.735849057, 23584.9056603774, 11792.45283018870),
        arrayOf(107.0,  560747.663551402, 23364.4859813084, 11682.24299065420),
        arrayOf(108.0,  555555.555555556, 23148.1481481482, 11574.07407407410),
        arrayOf(109.0,  550458.715596330, 22935.7798165138, 11467.88990825690),
        arrayOf(110.0,  545454.545454545, 22727.2727272727, 11363.63636363640),
        arrayOf(111.0,  540540.540540541, 22522.5225225225, 11261.26126126130),
        arrayOf(112.0,  535714.285714286, 22321.4285714286, 11160.71428571430),
        arrayOf(113.0,  530973.451327434, 22123.8938053098, 11061.94690265490),
        arrayOf(114.0,  526315.789473684, 21929.8245614035, 10964.91228070180),
        arrayOf(115.0,  521739.130434783, 21739.1304347826, 10869.56521739130),
        arrayOf(116.0,  517241.379310345, 21551.7241379310, 10775.86206896550),
        arrayOf(117.0,  512820.512820513, 21367.5213675214, 10683.76068376070),
        arrayOf(118.0,  508474.576271186, 21186.4406779661, 10593.22033898300),
        arrayOf(119.0,  504201.680672269, 21008.4033613445, 10504.20168067230),
        arrayOf(120.0,  500000.000000000, 20833.3333333333, 10416.66666666670),
        arrayOf(121.0,  495867.768595041, 20661.1570247934, 10330.57851239670),
        arrayOf(122.0,  491803.278688525, 20491.8032786885, 10245.90163934430),
        arrayOf(123.0,  487804.878048780, 20325.2032520325, 10162.60162601630),
        arrayOf(124.0,  483870.967741935, 20161.2903225806, 10080.64516129030),
        arrayOf(125.0,  480000.000000000, 20000.0000000000, 10000.00000000000),
        arrayOf(126.0,  476190.476190476, 19841.2698412698,  9920.63492063492),
        arrayOf(127.0,  472440.944881890, 19685.0393700788,  9842.51968503938),
        arrayOf(128.0,  468750.000000000, 19531.2500000000,  9765.62500000000),
        arrayOf(129.0,  465116.279069767, 19379.8449612403,  9689.92248062015),
        arrayOf(130.0,  461538.461538462, 19230.7692307693,  9615.38461538463),
        arrayOf(131.0,  458015.267175573, 19083.9694656489,  9541.98473282444),
        arrayOf(132.0,  454545.454545455, 18939.3939393940,  9469.69696969698),
        arrayOf(133.0,  451127.819548872, 18796.9924812030,  9398.49624060150),
        arrayOf(134.0,  447761.194029851, 18656.7164179105,  9328.35820895523),
        arrayOf(135.0,  444444.444444444, 18518.5185185185,  9259.25925925925),
        arrayOf(136.0,  441176.470588235, 18382.3529411765,  9191.17647058823),
        arrayOf(137.0,  437956.204379562, 18248.1751824818,  9124.08759124088),
        arrayOf(138.0,  434782.608695652, 18115.9420289855,  9057.97101449275),
        arrayOf(139.0,  431654.676258993, 17985.6115107914,  8992.80575539569),
        arrayOf(140.0,  428571.428571429, 17857.1428571429,  8928.57142857144),
        arrayOf(141.0,  425531.914893617, 17730.4964539007,  8865.24822695035),
        arrayOf(142.0,  422535.211267606, 17605.6338028169,  8802.81690140846),
        arrayOf(143.0,  419580.419580420, 17482.5174825175,  8741.25874125875),
        arrayOf(144.0,  416666.666666667, 17361.1111111111,  8680.55555555556),
        arrayOf(145.0,  413793.103448276, 17241.3793103448,  8620.68965517242),
        arrayOf(146.0,  410958.904109589, 17123.2876712329,  8561.64383561644),
        arrayOf(147.0,  408163.265306122, 17006.8027210884,  8503.40136054421),
        arrayOf(148.0,  405405.405405405, 16891.8918918919,  8445.94594594594),
        arrayOf(149.0,  402684.563758389, 16778.5234899329,  8389.26174496644),
        arrayOf(150.0,  400000.000000000, 16666.6666666667,  8333.33333333333),
        arrayOf(151.0,  397350.993377483, 16556.2913907285,  8278.14569536423),
        arrayOf(152.0,  394736.842105263, 16447.3684210526,  8223.68421052631),
        arrayOf(153.0,  392156.862745098, 16339.8692810458,  8169.93464052288),
        arrayOf(154.0,  389610.389610390, 16233.7662337663,  8116.88311688313),
        arrayOf(155.0,  387096.774193548, 16129.0322580645,  8064.51612903225),
        arrayOf(156.0,  384615.384615385, 16025.6410256410,  8012.82051282052),
        arrayOf(157.0,  382165.605095541, 15923.5668789809,  7961.78343949044),
        arrayOf(158.0,  379746.835443038, 15822.7848101266,  7911.39240506329),
        arrayOf(159.0,  377358.490566038, 15723.2704402516,  7861.63522012579),
        arrayOf(160.0,  375000.000000000, 15625.0000000000,  7812.50000000000),
        arrayOf(161.0,  372670.807453416, 15527.9503105590,  7763.97515527950),
        arrayOf(162.0,  370370.370370370, 15432.0987654321,  7716.04938271604),
        arrayOf(163.0,  368098.159509202, 15337.4233128834,  7668.71165644171),
        arrayOf(164.0,  365853.658536585, 15243.9024390244,  7621.95121951219),
        arrayOf(165.0,  363636.363636364, 15151.5151515152,  7575.75757575758),
        arrayOf(166.0,  361445.783132530, 15060.2409638554,  7530.12048192771),
        arrayOf(167.0,  359281.437125749, 14970.0598802395,  7485.02994011977),
        arrayOf(168.0,  357142.857142857, 14880.9523809524,  7440.47619047619),
        arrayOf(169.0,  355029.585798817, 14792.8994082840,  7396.44970414202),
        arrayOf(170.0,  352941.176470588, 14705.8823529412,  7352.94117647058),
        arrayOf(171.0,  350877.192982456, 14619.8830409357,  7309.94152046783),
        arrayOf(172.0,  348837.209302326, 14534.8837209303,  7267.44186046513),
        arrayOf(173.0,  346820.809248555, 14450.8670520231,  7225.43352601156),
        arrayOf(174.0,  344827.586206897, 14367.8160919540,  7183.90804597702),
        arrayOf(175.0,  342857.142857143, 14285.7142857143,  7142.85714285715),
        arrayOf(176.0,  340909.090909091, 14204.5454545455,  7102.27272727273),
        arrayOf(177.0,  338983.050847458, 14124.2937853108,  7062.14689265538),
        arrayOf(178.0,  337078.651685393, 14044.9438202247,  7022.47191011235),
        arrayOf(179.0,  335195.530726257, 13966.4804469274,  6983.24022346369),
        arrayOf(180.0,  333333.333333333, 13888.8888888889,  6944.44444444444),
        arrayOf(181.0,  331491.712707182, 13812.1546961326,  6906.07734806629),
        arrayOf(182.0,  329670.329670330, 13736.2637362638,  6868.13186813188),
        arrayOf(183.0,  327868.852459016, 13661.2021857923,  6830.60109289617),
        arrayOf(184.0,  326086.956521739, 13586.9565217391,  6793.47826086956),
        arrayOf(185.0,  324324.324324324, 13513.5135135135,  6756.75675675675),
        arrayOf(186.0,  322580.645161290, 13440.8602150538,  6720.43010752688),
        arrayOf(187.0,  320855.614973262, 13368.9839572193,  6684.49197860963),
        arrayOf(188.0,  319148.936170213, 13297.8723404255,  6648.93617021277),
        arrayOf(189.0,  317460.317460317, 13227.5132275132,  6613.75661375660),
        arrayOf(190.0,  315789.473684211, 13157.8947368421,  6578.94736842106),
        arrayOf(191.0,  314136.125654450, 13089.0052356021,  6544.50261780104),
        arrayOf(192.0,  312500.000000000, 13020.8333333333,  6510.41666666667),
        arrayOf(193.0,  310880.829015544, 12953.3678756477,  6476.68393782383),
        arrayOf(194.0,  309278.350515464, 12886.5979381443,  6443.29896907217),
        arrayOf(195.0,  307692.307692308, 12820.5128205128,  6410.25641025642),
        arrayOf(196.0,  306122.448979592, 12755.1020408163,  6377.55102040817),
        arrayOf(197.0,  304568.527918782, 12690.3553299493,  6345.17766497463),
        arrayOf(198.0,  303030.303030303, 12626.2626262626,  6313.13131313131),
        arrayOf(199.0,  301507.537688442, 12562.8140703518,  6281.40703517588),
        arrayOf(200.0,  300000.000000000, 12500.0000000000,  6250.00000000000),
        arrayOf(201.0,  298507.462686567, 12437.8109452736,  6218.90547263681))

    val microsInBeatTests: Array<Array<Double>> = arrayOf(
        arrayOf(60.0,  1000000.000000000),
        arrayOf(61.0,	983606.557377049),
        arrayOf(62.0,	967741.935483871),
        arrayOf(63.0,	952380.952380952),
        arrayOf(64.0,	937500.000000000),
        arrayOf(65.0,	923076.923076923),
        arrayOf(66.0,	909090.909090909),
        arrayOf(67.0,	895522.388059701),
        arrayOf(68.0,	882352.941176471),
        arrayOf(69.0,	869565.217391304),
        arrayOf(70.0,	857142.857142857),
        arrayOf(71.0,	845070.422535211),
        arrayOf(72.0,	833333.333333333),
        arrayOf(73.0,	821917.808219178),
        arrayOf(74.0,	810810.810810811),
        arrayOf(75.0,	800000.000000000),
        arrayOf(76.0,	789473.684210526),
        arrayOf(77.0,	779220.779220779),
        arrayOf(78.0,	769230.769230769),
        arrayOf(79.0,	759493.670886076),
        arrayOf(80.0,	750000.000000000),
        arrayOf(81.0,	740740.740740741),
        arrayOf(82.0,	731707.317073171),
        arrayOf(83.0,	722891.566265060),
        arrayOf(84.0,	714285.714285714),
        arrayOf(85.0,	705882.352941176),
        arrayOf(86.0,	697674.418604651),
        arrayOf(87.0,	689655.172413793),
        arrayOf(88.0,	681818.181818182),
        arrayOf(89.0,	674157.303370787),
        arrayOf(90.0,	666666.666666667),
        arrayOf(91.0,	659340.659340659),
        arrayOf(92.0,	652173.913043478),
        arrayOf(93.0,	645161.290322581),
        arrayOf(94.0,	638297.872340426),
        arrayOf(95.0,	631578.947368421),
        arrayOf(96.0,	625000.000000000),
        arrayOf(97.0,	618556.701030928),
        arrayOf(98.0,	612244.897959184),
        arrayOf(99.0,	606060.606060606),
        arrayOf(100.0, 600000.000000000),
        arrayOf(101.0, 594059.405940594),
        arrayOf(102.0, 588235.294117647),
        arrayOf(103.0, 582524.271844660),
        arrayOf(104.0, 576923.076923077),
        arrayOf(105.0, 571428.571428571),
        arrayOf(106.0, 566037.735849057),
        arrayOf(107.0, 560747.663551402),
        arrayOf(108.0, 555555.555555556),
        arrayOf(109.0, 550458.715596330),
        arrayOf(110.0, 545454.545454545),
        arrayOf(111.0, 540540.540540541),
        arrayOf(112.0, 535714.285714286),
        arrayOf(113.0, 530973.451327434),
        arrayOf(114.0, 526315.789473684),
        arrayOf(115.0, 521739.130434783),
        arrayOf(116.0, 517241.379310345),
        arrayOf(117.0, 512820.512820513),
        arrayOf(118.0, 508474.576271186),
        arrayOf(119.0, 504201.680672269),
        arrayOf(120.0, 500000.000000000),
        arrayOf(121.0, 495867.768595041),
        arrayOf(122.0, 491803.278688525),
        arrayOf(123.0, 487804.878048780),
        arrayOf(124.0, 483870.967741935),
        arrayOf(125.0, 480000.000000000),
        arrayOf(126.0, 476190.476190476),
        arrayOf(127.0, 472440.944881890),
        arrayOf(128.0, 468750.000000000),
        arrayOf(129.0, 465116.279069767),
        arrayOf(130.0, 461538.461538462),
        arrayOf(131.0, 458015.267175573),
        arrayOf(132.0, 454545.454545455),
        arrayOf(133.0, 451127.819548872),
        arrayOf(134.0, 447761.194029851),
        arrayOf(135.0, 444444.444444444),
        arrayOf(136.0, 441176.470588235),
        arrayOf(137.0, 437956.204379562),
        arrayOf(138.0, 434782.608695652),
        arrayOf(139.0, 431654.676258993),
        arrayOf(140.0, 428571.428571429),
        arrayOf(141.0, 425531.914893617),
        arrayOf(142.0, 422535.211267606),
        arrayOf(143.0, 419580.419580420),
        arrayOf(144.0, 416666.666666667),
        arrayOf(145.0, 413793.103448276),
        arrayOf(146.0, 410958.904109589),
        arrayOf(147.0, 408163.265306122),
        arrayOf(148.0, 405405.405405405),
        arrayOf(149.0, 402684.563758389),
        arrayOf(150.0, 400000.000000000),
        arrayOf(151.0, 397350.993377483),
        arrayOf(152.0, 394736.842105263),
        arrayOf(153.0, 392156.862745098),
        arrayOf(154.0, 389610.389610390),
        arrayOf(155.0, 387096.774193548),
        arrayOf(156.0, 384615.384615385),
        arrayOf(157.0, 382165.605095541),
        arrayOf(158.0, 379746.835443038),
        arrayOf(159.0, 377358.490566038),
        arrayOf(160.0, 375000.000000000),
        arrayOf(161.0, 372670.807453416),
        arrayOf(162.0, 370370.370370370),
        arrayOf(163.0, 368098.159509202),
        arrayOf(164.0, 365853.658536585),
        arrayOf(165.0, 363636.363636364),
        arrayOf(166.0, 361445.783132530),
        arrayOf(167.0, 359281.437125749),
        arrayOf(168.0, 357142.857142857),
        arrayOf(169.0, 355029.585798817),
        arrayOf(170.0, 352941.176470588),
        arrayOf(171.0, 350877.192982456),
        arrayOf(172.0, 348837.209302326),
        arrayOf(173.0, 346820.809248555),
        arrayOf(174.0, 344827.586206897),
        arrayOf(175.0, 342857.142857143),
        arrayOf(176.0, 340909.090909091),
        arrayOf(177.0, 338983.050847458),
        arrayOf(178.0, 337078.651685393),
        arrayOf(179.0, 335195.530726257),
        arrayOf(180.0, 333333.333333333),
        arrayOf(181.0, 331491.712707182),
        arrayOf(182.0, 329670.329670330),
        arrayOf(183.0, 327868.852459016),
        arrayOf(184.0, 326086.956521739),
        arrayOf(185.0, 324324.324324324),
        arrayOf(186.0, 322580.645161290),
        arrayOf(187.0, 320855.614973262),
        arrayOf(188.0, 319148.936170213),
        arrayOf(189.0, 317460.317460317),
        arrayOf(190.0, 315789.473684211),
        arrayOf(191.0, 314136.125654450),
        arrayOf(192.0, 312500.000000000),
        arrayOf(193.0, 310880.829015544),
        arrayOf(194.0, 309278.350515464),
        arrayOf(195.0, 307692.307692308),
        arrayOf(196.0, 306122.448979592),
        arrayOf(197.0, 304568.527918782),
        arrayOf(198.0, 303030.303030303),
        arrayOf(199.0, 301507.537688442),
        arrayOf(200.0, 300000.000000000),
        arrayOf(201.0, 298507.462686567))
}